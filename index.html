<!doctype html>
<html lang="fr">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>QUESTIONNAIRE AVANT CONSULTATION</title>
<style>
  :root{
    --red:#b91c1c; --redbg:#fee2e2; --border:#e5e7eb; --fg:#111; --muted:#6b7280;
    --hl-bg:#fef08a;          /* jaune clair pour surlignage intitulés */
    --value-yellow:#ca8a04;   /* jaune ambré pour le texte des réponses */
  }
  body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,Arial,sans-serif;margin:0;padding:24px;background:#f7f7f8;color:var(--fg)}
  .card{background:#fff;border:1px solid var(--border);border-radius:12px;max-width:880px;margin:0 auto 18px auto;padding:20px;box-shadow:0 1px 2px rgba(0,0,0,.04)}
  h1{font-size:26px;margin:0 0 6px;letter-spacing:.5px}
  h2{font-size:18px;margin:12px 0 8px}
  .muted{color:var(--muted);font-size:12px}
  .btn{appearance:none;border:1px solid #111;background:#111;color:#fff;padding:10px 14px;border-radius:10px;cursor:pointer;font-weight:600}
  .btn.secondary{background:#fff;color:#111}
  .row{margin:10px 0}
  input,textarea,select{width:100%;padding:10px;border:1px solid #d1d5db;border-radius:10px;font-size:16px}
  .chips{display:flex;flex-wrap:wrap;gap:8px}
  .chip{border:1px solid #d1d5db;border-radius:999px;padding:8px 12px;cursor:pointer;background:#fff}
  .chip.selected{background:#111;color:#fff;border-color:#111}
  .footer{display:flex;gap:10px;flex-wrap:wrap;margin-top:14px}
  .grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(220px,1fr));gap:12px;margin-top:12px}
  .tile{border:1px solid var(--border);border-radius:12px;padding:14px;background:#fff}
  .flagbox{padding:12px;border-radius:12px;background:var(--redbg);border:1px solid #fecaca;margin:10px 0}
  .flagtitle{font-weight:800;color:var(--red);margin-bottom:6px}
  .flagreason{color:var(--red);font-weight:700}
  .ok{padding:10px 12px;border-radius:12px;background:#e0f2fe;color:#075985;border:1px solid #bae6fd;margin:10px 0;font-weight:600}

  /* Synthèse : intitulés surlignés + valeurs en jaune */
  .summary{background:#f8fafc;border:1px solid #e2e8f0;border-radius:12px;padding:12px}
  .sline{margin:4px 0;line-height:1.45}
  .slabel{font-weight:800;background:var(--hl-bg);padding:2px 6px;border-radius:6px}
  .svalue{color:var(--value-yellow);font-weight:700}

  @media (prefers-color-scheme: dark){
    body{background:#0b0c0e;color:#e5e7eb}
    .card{background:#111317;border-color:#1f232a}
    .tile{background:#111317}
    .summary{background:#0f1216;border-color:#1f232a}
  }
</style>
</head>
<body>
  <div class="card">
    <h1>QUESTIONNAIRE AVANT CONSULTATION</h1>
    <div class="muted">Choisissez un motif. En cas d’urgence, appelez le 15.</div>
  </div>

  <!-- Accueil -->
  <div id="home" class="card">
    <h2>Motif de consultation</h2>
    <div class="grid">
      <div class="tile">
        <strong>Fièvre</strong>
        <p class="muted">Durée, température, signes d’alerte.</p>
        <button class="btn" onclick="startMotif('fievre')">Commencer</button>
      </div>
      <div class="tile">
        <strong>Douleur</strong>
        <p class="muted">Localisation, durée, intensité, signes d’alerte.</p>
        <button class="btn" onclick="startMotif('douleur')">Commencer</button>
      </div>
      <div class="tile">
        <strong>Mal de tête</strong>
        <p class="muted">Début, contexte, signes de gravité.</p>
        <button class="btn" onclick="startMotif('cephalees')">Commencer</button>
      </div>
      <div class="tile">
        <strong>Renouvellement d’ordonnance</strong>
        <p class="muted">Tolérance, mesures récentes, événements intercurrents.</p>
        <button class="btn" onclick="startMotif('renouvellement')">Commencer</button>
      </div>
    </div>
  </div>

  <!-- Questions + Synthèse -->
  <div id="questions" class="card" style="display:none"></div>
  <div id="printable" class="card" style="display:none"></div>

<script>
/*** PARAMÈTRES ***/
const MSSANTE_TO = "nom.prenom@votre-cabinet.mssante.fr"; // <-- à personnaliser

/*** MODÈLES ***/
const MODELS = {
  fievre: {
    titre: "FIÈVRE",
    nodes: [
      { id:"INTRO", type:"info", text:"Ce questionnaire prépare votre consultation. En cas de détresse, appelez le 15.", next:"DUREE" },
      { id:"DUREE", type:"duration", label:"Depuis quand avez-vous de la fièvre ?", next:"TMAX" },
      { id:"TMAX", type:"number", label:"Température maximale mesurée (°C)", next:"EVOL" },
      { id:"EVOL", type:"single_select", label:"Comment évolue votre fièvre ?", options:["Continue","Par pics","Je ne sais pas"], next:"SYMPT" },
      { id:"SYMPT", type:"multi_select", label:"Avez-vous un de ces signes ?", options:[
          {code:"dyspnee",label:"Essoufflement"},
          {code:"douleur_thx",label:"Douleur thoracique"},
          {code:"raideur",label:"Raideur de nuque"},
          {code:"purpura",label:"Taches violettes persistantes"},
          {code:"confusion",label:"Somnolence / confusion"},
          {code:"toux",label:"Toux"},
          {code:"digestif",label:"Vomissements / diarrhée"},
          {code:"eruption",label:"Éruption cutanée"}
        ],
        next:"FACTEURS"
      },
      { id:"FACTEURS", type:"multi_select", label:"Facteurs de risque", options:[
          {code:"grossesse",label:"Grossesse"},
          {code:"nourrisson",label:"Âge < 3 mois"},
          {code:"immuno",label:"Immunodépression"},
          {code:"age",label:"Âge > 75 ans"},
          {code:"chronique",label:"Maladie chronique"},
          {code:"aucun",label:"Aucun"}
        ], next:"TRAIT"
      },
      { id:"TRAIT", type:"text", label:"Traitements pris (nom, dose, efficacité)", next:"SYNTHESE" },
      { id:"SYNTHESE", type:"summary" }
    ],
    summary: (A, any) => lines([
      ["MOTIF","Fièvre"],
      ["DURÉE", A.DUREE || "(non précisée)"],
      ["TEMPÉRATURE MAX", (A.TMAX ?? "(non précisée)") + " °C"],
      ["ÉVOLUTION", A.EVOL||"—"],
      ["SIGNES ASSOCIÉS", list(A.SYMPT)],
      ["FACTEURS DE RISQUE", list(A.FACTEURS)],
      ["TRAITEMENTS", A.TRAIT||"Aucun"]
    ]),
    extraAlerts: (A, any) => {
      const arr=[];
      if(parseFloat(A.TMAX)>=40) arr.push("Température ≥ 40 °C");
      if(any(['dyspnee','douleur_thx','raideur','purpura','confusion'])) arr.push("Signes d’alerte associés");
      if(any(['grossesse','nourrisson','immuno'])) arr.push("Situation à risque");
      return arr;
    }
  },

  douleur: {
    titre: "DOULEUR",
    nodes: [
      { id:"INTRO", type:"info", text:"Ce questionnaire prépare votre consultation douleur. En cas d’urgence, appelez le 15.", next:"LOCALISATION" },
      { id:"LOCALISATION", type:"single_select", label:"Où est la douleur ?", options:["Tête","Poitrine","Abdomen","Dos","Membre","Autre"], next:"DUREE" },
      { id:"DUREE", type:"duration", label:"Depuis quand ?", next:"INTENSITE" },
      { id:"INTENSITE", type:"number", label:"Intensité (0 à 10)", next:"CARACTERE" },
      { id:"CARACTERE", type:"multi_select", label:"Caractère", options:["Brûlure","Piqûre","Crampes","Poids","Décharge","Pulsatile"], next:"SIGNES" },
      { id:"SIGNES", type:"multi_select", label:"Signes associés", options:[
          {code:"fievre",label:"Fièvre"},
          {code:"dyspnee",label:"Essoufflement"},
          {code:"deficit",label:"Déficit neurologique"},
          {code:"pc",label:"Perte de connaissance"}
        ], next:"TRAIT"
      },
      { id:"TRAIT", type:"text", label:"Qu’avez-vous pris ? (nom, dose, effet)", next:"SYNTHESE" },
      { id:"SYNTHESE", type:"summary" }
    ],
    summary: (A) => lines([
      ["MOTIF","Douleur"],
      ["LOCALISATION", A.LOCALISATION||"—"],
      ["DURÉE", A.DUREE||"(non précisée)"],
      ["INTENSITÉ", (A.INTENSITE ?? "—")+"/10"],
      ["CARACTÈRE", list(A.CARACTERE)],
      ["SIGNES ASSOCIÉS", list(A.SIGNES)],
      ["TRAITEMENTS", A.TRAIT||"Aucun"]
    ]),
    extraAlerts: (A, any) => {
      const arr=[]; 
      if(parseFloat(A.INTENSITE)>=8) arr.push("Douleur intense ≥ 8/10");
      if(any(['dyspnee','deficit','pc'])) arr.push("Signes d’alerte associés");
      if(A.LOCALISATION==="Poitrine" && any(['dyspnee'])) arr.push("Douleur thoracique + essoufflement");
      return arr;
    }
  },

  cephalees: {
    titre: "MAL DE TÊTE",
    nodes: [
      { id:"INTRO", type:"info", text:"Ce questionnaire prépare votre consultation pour céphalées. Appelez le 15 en cas d’urgence.", next:"DEBUT" },
      { id:"DEBUT", type:"single_select", label:"Début de la douleur", options:["Brutal (coup de tonnerre)","Progressif","Récurrent (déjà connu)"], next:"CONTEXTE" },
      { id:"CONTEXTE", type:"multi_select", label:"Contexte", options:[
          {code:"fievre",label:"Fièvre"},
          {code:"raideur",label:"Raideur de nuque"},
          {code:"trauma",label:"Traumatisme récent"},
          {code:"grossesse",label:"Grossesse/post-partum"},
          {code:"anticoag",label:"Anticoagulants"}
        ], next:"SYMPT"
      },
      { id:"SYMPT", type:"multi_select", label:"Signes associés", options:[
          {code:"deficit",label:"Déficit neuro (faiblesse, parole/vision)"},
          {code:"vomit",label:"Vomissements en jet"},
          {code:"photoph",label:"Photophobie"}
        ], next:"TRAIT"
      },
      { id:"TRAIT", type:"text", label:"Traitements pris (nom, dose, effet)", next:"SYNTHESE" },
      { id:"SYNTHESE", type:"summary" }
    ],
    summary: (A) => lines([
      ["MOTIF","Mal de tête"],
      ["DÉBUT", A.DEBUT||"—"],
      ["CONTEXTE", list(A.CONTEXTE)],
      ["SIGNES ASSOCIÉS", list(A.SYMPT)],
      ["TRAITEMENTS", A.TRAIT||"Aucun"]
    ]),
    extraAlerts: (A, any) => {
      const arr=[]; 
      if(A.DEBUT==="Brutal (coup de tonnerre)") arr.push("Céphalée d’installation brutale");
      if(any(['raideur','trauma','grossesse','anticoag'])) arr.push("Contexte à risque");
      if(any(['deficit'])) arr.push("Signes neurologiques associés");
      return arr;
    }
  },

  renouvellement: {
    titre: "RENOUVELLEMENT D’ORDONNANCE",
    nodes: [
      { id:"INTRO", type:"info", text:"Ce questionnaire prépare le renouvellement. En cas d’urgence, appelez le 15.", next:"TOLERANCE" },
      { id:"TOLERANCE", type:"text", label:"Tolérance / effets indésirables récents", next:"MESURES" },
      { id:"MESURES", type:"text", label:"Mesures récentes si connues (TA, glycémie, poids, cholestérol…)", next:"INTERCURRENTS" },
      { id:"INTERCURRENTS", type:"text", label:"Événements intercurrents (hospitalisation, nouveau traitement, symptôme nouveau…)", next:"SYNTHESE" },
      { id:"SYNTHESE", type:"summary" }
    ],
    summary: (A) => lines([
      ["MOTIF","Renouvellement d’ordonnance"],
      ["TOLÉRANCE / EI", A.TOLERANCE||"—"],
      ["MESURES RÉCENTES", A.MESURES||"—"],
      ["ÉVÉNEMENTS INTERCURRENTS", A.INTERCURRENTS||"—"]
    ]),
    extraAlerts: (A) => {
      const arr=[];
      if((A.MESURES||"").match(/(TA|tension).*(2[0-9]{2}|1[8-9][0-9])/i)) arr.push("TA possiblement élevée");
      if((A.MESURES||"").match(/glyc(émie)?.*(>?\s?3[0-9]{2}|30)\b/i)) arr.push("Glycémie possiblement élevée");
      if((A.INTERCURRENTS||"").match(/(douleur thoracique|dyspn(ée|ee)|malaise|syncope)/i)) arr.push("Symptômes intercurrents à prioriser");
      return arr;
    }
  }
};

/*** MOTEUR COMMUN ***/
const home=document.getElementById("home");
const app=document.getElementById("questions");
const printable=document.getElementById("printable");
let CURRENT=null; let answers={}; let alerts=[];

function startMotif(key){
  CURRENT = MODELS[key];
  home.style.display="none";
  app.style.display="block";
  printable.style.display="none";
  answers={}; alerts=[];
  goto("INTRO");
}

function render(node){
  app.innerHTML=""; const h=document.createElement("h2");
  h.textContent=node.label || `Question — ${CURRENT.titre}`; app.appendChild(h);
  if(node.type==="info"){
    app.innerHTML+=`<div class="ok">${node.text}</div>`;
    footer([{label:"Commencer",action:()=>goto(node.next)},{label:"Changer de motif",action:()=>backHome(),secondary:true}]); return;
  }
  let row=document.createElement("div"); row.className="row"; app.appendChild(row); let getVal=()=>null;
  if(node.type==="duration"){ row.innerHTML='<input id="duree" placeholder="ex: 2 jours">'; getVal=()=>document.getElementById("duree").value; }
  else if(node.type==="number"){ const i=document.createElement("input"); i.type="number"; i.step="0.1"; row.appendChild(i); getVal=()=>parseFloat(i.value); }
  else if(node.type==="single_select"){ const s=document.createElement("select"); s.innerHTML='<option value="">— Sélectionner —</option>'+(node.options||[]).map(o=>`<option>${o}</option>`).join(""); row.appendChild(s); getVal=()=>s.value; }
  else if(node.type==="multi_select"){ const wrap=document.createElement("div"); wrap.className="chips"; (node.options||[]).forEach(o=>{const b=document.createElement("button"); b.type="button"; b.textContent=o.label||o; b.dataset.code=o.code||o; b.className="chip"; b.onclick=()=>b.classList.toggle("selected"); wrap.appendChild(b);}); row.appendChild(wrap); getVal=()=>Array.from(row.querySelectorAll(".chip.selected")).map(b=>({code:b.dataset.code,label:b.textContent})); }
  else if(node.type==="text"){ const t=document.createElement("textarea"); t.rows=3; row.appendChild(t); getVal=()=>t.value.trim(); }
  else if(node.type==="summary"){ return renderSummary(); }
  footer([
    {label:"Suivant",action:()=>{answers[node.id]=normalizeValue(getVal()); next(node,answers[node.id]);}},
    {label:"Changer de motif",action:()=>backHome(),secondary:true}
  ]);
}

function normalizeValue(val){ return val; }
function footer(btns){ const f=document.createElement("div"); f.className="footer"; btns.forEach(b=>{const el=document.createElement("button"); el.className="btn"+(b.secondary?" secondary":""); el.textContent=b.label; el.onclick=b.action; f.appendChild(el);}); app.appendChild(f); }
function goto(id){ const n=(CURRENT.nodes||[]).find(x=>x.id===id); render(n); }
function backHome(){ home.style.display="block"; app.style.display="none"; printable.style.display="none"; }

function any(codes){
  const all = [].concat(answers.SYMPT||[], answers.SIGNES||[], answers.CONTEXTE||[], answers.FACTEURS||[]);
  return all.some(o => codes.includes(o.code));
}

function next(node,val){
  let dest = node.next;
  if(Array.isArray(dest)){
    let fallback=null;
    for(const r of dest){
      if(r.else){ fallback=r.else; continue; }
      if(r.if==="value>=40" && parseFloat(val)>=40) return goto(r.goto);
    }
    return goto(fallback);
  }
  goto(dest);
}

/*** Formatage synthèse ***/
function list(arr){ return (arr && arr.length)? arr.map(x=>x.label).join(", ") : "Aucun"; }
function lines(pairs){
  // pairs = [[LABEL, value], ...]  → HTML formaté avec surlignage + texte jaune
  return pairs.map(([k,v]) =>
    `<div class="sline"><span class="slabel">${(k||"").toUpperCase()}</span> : <span class="svalue">${escapeHTML(v)}</span></div>`
  ).join("");
}
function escapeHTML(x){
  if(x===undefined || x===null) return "";
  return String(x).replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;");
}

function renderSummary(){
  const A = answers; // valeurs déjà “plates”
  // compléter les drapeaux rouges selon le modèle
  alerts = (CURRENT.extraAlerts && CURRENT.extraAlerts(A, any)) || [];

  let html="";
  if(alerts.length>0){
    html += "<div class='flagbox'><div class='flagtitle'>⚠️ DRAPEAUX ROUGES</div>";
    alerts.forEach(a=> html += "<div class='flagreason'>• "+escapeHTML(a)+"</div>");
    html += "</div>";
  } else {
    html += "<div class='ok'>Aucun drapeau rouge détecté.</div>";
  }

  html += `<div class="summary" id="synthText">${CURRENT.summary(A, any)}</div>`;
  html += `<div class="footer">
      <button class="btn" id="btnCopy">Copier la synthèse</button>
      <button class="btn" id="btnMSS">Envoyer via MSSanté</button>
      <button class="btn" id="btnHome">Changer de motif</button>
      <button class="btn" id="btnRestart">Recommencer</button>
    </div>`;

  printable.innerHTML = html;
  printable.style.display="block";
  app.style.display="none";

  document.getElementById("btnCopy").onclick = ()=>{
    const synth=document.getElementById("synthText").innerText;
    navigator.clipboard.writeText(synth).then(()=>{alert("Synthèse copiée. Vous pouvez la coller dans Madeformed.");});
  };
  document.getElementById("btnMSS").onclick = ()=>{
    // composer un mail texte (les styles ne passent pas par email)
    const plain = document.getElementById("synthText").innerText.replace(/\s+\n/g,"\n");
    const subject="Pré-consultation — "+CURRENT.titre;
    const body=(alerts.length?("Drapeaux rouges: "+alerts.join(", ")+"\n\n"):"")+plain+"\n\n— Questionnaire pré-consultation";
    const url="mailto:"+encodeURIComponent(MSSANTE_TO)
      +"?subject="+encodeURIComponent(subject)
      +"&body="+encodeURIComponent(body);
    window.location.href=url;
  };
  document.getElementById("btnHome").onclick = ()=>{ alerts=[]; for (const k in answers) delete answers[k]; printable.style.display="none"; home.style.display="block"; };
  document.getElementById("btnRestart").onclick = ()=>{ alerts=[]; for (const k in answers) delete answers[k]; printable.style.display="none"; app.style.display="block"; goto("INTRO"); };
}
</script>
</body>
</html>
